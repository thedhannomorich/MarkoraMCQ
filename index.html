<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markora</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes scaleIn {
  0% { opacity: 0; transform: scale(0.95); }
  100% { opacity: 1; transform: scale(1); }
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

@keyframes bounce {
  0% { transform: scale(1); }
  50% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

/* Variables */
:root {
  --primary-color: #ffffff;
  --secondary-color: #aaaaaa;
  --accent-color: #8ac926;
  --success-color: #4caf50;
  --error-color: #f44336;
  --warning-color: #ff9800;
  --dark-bg: #121212;
  --dark-card: #1e1e1e;
  --dark-text-color: #f0f0f0;
  --bangla-font: 'Hind Siliguri', sans-serif;
  --english-font: 'Poppins', sans-serif;
  --border-radius: 10px;
}

/* Global */
* {
  transition: all 0.3s ease;
}

body {
  font-family: var(--bangla-font);
  margin: 0;
  background: var(--dark-bg);
  color: var(--dark-text-color);
  line-height: 1.6;
}

h2, h3 {
  color: var(--primary-color);
  text-align: center;
  margin-bottom: 25px;
  border-bottom: 2px solid var(--accent-color);
  padding-bottom: 10px;
  font-weight: 700;
}

/* Containers with fadeIn */
.container,
.question,
.subject-card,
.modal-content,
.stat-item,
.instructions,
.history-preview,
.analysis-container {
  background: var(--dark-card);
  color: var(--dark-text-color);
  border-radius: var(--border-radius);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  animation: fadeIn 0.6s ease;
  animation-fill-mode: both;
}

.container {
  max-width: 1000px;
  margin: 20px auto;
  padding: 25px;
}

/* Inputs */
input[type="text"],
input[type="number"],
select {
  width: 100%;
  padding: 10px;
  background: #2c2c2c;
  border: 1px solid #444;
  border-radius: 5px;
  color: var(--dark-text-color);
}

label {
  font-weight: 700;
  margin-bottom: 5px;
  display: block;
}

/* Buttons */
.btn,
.option-btn,
.theme-toggle {
  font-weight: bold;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.btn {
  background: var(--accent-color);
  color: #000;
  padding: 10px 20px;
  margin-right: 10px;
}

.btn:hover,
.option-btn:hover,
.theme-toggle:hover {
  animation: float 2s infinite ease-in-out;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
  transform: translateY(-3px);
}

.btn:active,
.option-btn:active,
.theme-toggle:active {
  animation: bounce 0.2s ease;
}

.btn-secondary {
  background: #555;
  color: #fff;
}

.btn-secondary:hover {
  background: #666;
}

.btn-success {
  background: var(--success-color);
  color: #000;
}

.btn-success:hover {
  background: #3d8b40;
}

.btn-danger {
  background: var(--error-color);
  color: #fff;
}

.btn-danger:hover {
  background: #d32f2f;
}

.btn-warning {
  background: var(--warning-color);
  color: #000;
}

.btn-warning:hover {
  background: #e68a00;
}

/* Timer */
#timer {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #2c2c2c;
  color: var(--primary-color);
  padding: 10px 15px;
  border-radius: 5px;
  font-weight: bold;
}

/* Question container grid */
#questionContainer {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.question {
  border: 1px solid #333;
  padding: 15px;
  display: flex;
  flex-direction: column;
}

.question-number {
  color: var(--accent-color);
  font-weight: bold;
}

.options-container {
  display: flex;
  flex-wrap: wrap;
  margin-top: auto;
  gap: 10px;
}

.option-btn {
  width: 40px;
  height: 40px;
  border: 2px solid #666;
  background: #333;
  border-radius: 50%;
  color: var(--primary-color);
}

.option-btn.selected {
  background: var(--accent-color);
  color: #000;
  border-color: var(--accent-color);
}

.question.mistake {
  border: 2px solid var(--error-color);
  background: #442a2a;
}

.question.correct {
  border: 2px solid var(--success-color);
  background: #2a3a2a;
}

/* Controls layout */
.controls {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 30px;
}

/* Modal */
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  max-width: 500px;
  padding: 30px;
  text-align: center;
  animation: scaleIn 0.4s ease;
  animation-fill-mode: both;
}

/* Modal buttons */
.modal-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
}

/* Progress bar */
.progress-container {
  background: #333;
  border-radius: 5px;
  margin: 20px 0;
}

.progress-bar {
  height: 20px;
  width: 0%;
  background: var(--accent-color);
  border-radius: 5px;
  text-align: center;
  font-size: 12px;
  color: #000;
  transition: width 0.3s ease;
}

/* Stats */
.stats {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  margin: 20px 0;
}

.stat-item {
  text-align: center;
  flex: 1;
  margin: 10px;
}

.stat-value {
  font-size: 24px;
  color: var(--primary-color);
}

/* Subject grid */
.subject-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

.subject-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  cursor: pointer;
  min-height: 120px;
  animation: fadeIn 0.6s ease;
  animation-fill-mode: both;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.subject-card:hover {
  transform: translateY(-7px) scale(1.05);
  box-shadow: 0 10px 25px rgba(138, 201, 38, 0.5);
}

/* Subject card heading */
.subject-card h3 {
  margin-top: 0;
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
  margin-bottom: 10px;
}

/* Filter controls */
.filter-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-controls select,
.filter-controls input {
  flex: 1;
  min-width: 150px;
  background: #2c2c2c;
  border: 1px solid #444;
  border-radius: 5px;
  color: var(--dark-text-color);
  padding: 10px;
}

/* Theme toggle button */
.theme-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--accent-color);
  color: #000;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 20px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

/* Instructions list */
.instructions ul {
  padding-left: 20px;
}

/* History preview */
.history-scroll {
  display: flex;
  gap: 15px;
  overflow-x: auto;
  padding: 10px 0;
}

.history-item {
  min-width: 200px;
  background: #333;
  border-radius: 8px;
  padding: 15px;
  flex-shrink: 0;
  animation: fadeIn 0.6s ease;
  animation-fill-mode: both;
}

/* Analysis container */
.analysis-container {
  margin: 30px 0;
  padding: 20px;
}

/* Chart styles */
.bar {
  width: 30px;
  margin: 0 auto;
  position: relative;
  transition: height 0.5s ease;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 10px;
}

.chart-label {
  margin-top: 5px;
  text-align: center;
  font-size: 10px;
  white-space: nowrap;
  transform: rotate(-45deg);
  transform-origin: left;
  position: absolute;
  bottom: -25px;
  left: 50%;
  width: 80px;
}

.chart-container {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  height: 300px;
  padding: 20px 0;
  overflow-x: auto;
}

.bar-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0 5px;
  height: 100%;
  position: relative;
}

/* Time filter buttons */
.time-filter {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.time-filter button {
  background: #333;
  border: none;
  border-radius: 5px;
  padding: 8px 15px;
  color: var(--primary-color);
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.time-filter button.active {
  background: var(--accent-color);
  color: #000;
}

/* Responsive tweaks */
@media (max-width: 768px) {
  .container { padding: 15px; margin: 10px; }
  #questionContainer { grid-template-columns: 1fr; }
  .option-btn { width: 35px; height: 35px; }
  .stats { flex-direction: column; }
  .subject-grid { grid-template-columns: 1fr; }
}

/* English font content */
.english-content {
  font-family: var(--english-font);
  position: relative;
}

.english-content::after {
  content: "PREMIUM";
  position: absolute;
  top: -10px;
  right: -10px;
  background: gold;
  color: #000;
  padding: 2px 5px;
  border-radius: 5px;
  font-size: 10px;
  font-weight: bold;
}
.footer {
  text-align: center;
  padding: 1em 0;
  font-family: var(--bangla-font);
  font-size: 14px;
  color: var(--secondary-color);
  border-top: 1px solid #333;
  background-color: var(--dark-card);
}

.footer-name,
.footer-email {
  color: var(--accent-color);
  font-weight: 700;
  cursor: default;
  user-select: none;
  transition: color 0.3s ease, text-shadow 0.3s ease;
}

.footer-email {
  cursor: pointer;
}

.footer-email:hover {
  color: #a8d64e; /* lighter accent */
  text-shadow: 0 0 8px rgba(138, 201, 38, 0.6);
  animation: float 2s infinite ease-in-out;
}
</style>
</head>
<body>

<div class="container">
  <div id="homeScreen" class="home-container">
    <h1 align = "center">Markora</h1>
    <p>Practice and improve your OMR sheet filling skills with this interactive system.It is completely free.</p>
    
    <div class="instructions">
      <h3>How to Use:</h3>
<ul>
  <li>Select a subject from the list below.</li>
  <li>Enter the test details, including the title, question range, and time allotted per question.</li>
  <li>Obtain a physical copy of the question paper.</li>
  <li>Answer the questions by selecting one of the options (‡¶ï, ‡¶ñ, ‡¶ó, ‡¶ò).</li>
  <li>Submit your answers using the solution bank provided with the material once you have completed the test.</li>
  <li>Enter the correct answers to calculate your score.</li>
  <li>Review your history to monitor your progress over time.</li>
</ul>

<h3>Tips:</h3>
<ul>
  <li>Practice regularly to enhance your speed and accuracy.</li>
  <li>Begin with more time per question, then gradually reduce it as you improve.</li>
  <li>Analyze mistakes recorded in your history to avoid repeating them.</li>
  <li>This tool is particularly beneficial for HSC candidates and admission test aspirants.</li>
</ul>
    </div>
    
    <h3>Select Subject:</h3>
    <div class="subject-grid">
      <div class="subject-card" data-subject="English 1st Paper" onclick="selectSubject('English 1st Paper')">
        <div class="subject-icon">üìò</div>
        <h3>English 1st Paper</h3>
      </div>
      <div class="subject-card" data-subject="English 2nd Paper" onclick="selectSubject('English 2nd Paper')">
        <div class="subject-icon">üìó</div>
        <h3>English 2nd Paper</h3>
      </div>
      <div class="subject-card" data-subject="Bengali 1st Paper" onclick="selectSubject('Bengali 1st Paper')">
        <div class="subject-icon">üìï</div>
        <h3>Bengali 1st Paper</h3>
      </div>
      <div class="subject-card" data-subject="Bengali 2nd Paper" onclick="selectSubject('Bengali 2nd Paper')">
        <div class="subject-icon">üìô</div>
        <h3>Bengali 2nd Paper</h3>
      </div>
      <div class="subject-card" data-subject="Mathematics 1st Paper" onclick="selectSubject('Mathematics 1st Paper')">
        <div class="subject-icon">üßÆ</div>
        <h3>Mathematics 1st Paper</h3>
      </div>
      <div class="subject-card" data-subject="Mathematics 2nd Paper" onclick="selectSubject('Mathematics 2nd Paper')">
        <div class="subject-icon">üìê</div>
        <h3>Mathematics 2nd Paper</h3>
      </div>
      <div class="subject-card" data-subject="Physics 1st Paper" onclick="selectSubject('Physics 1st Paper')">
        <div class="subject-icon">‚öõÔ∏è</div>
        <h3>Physics 1st Paper</h3>
      </div>
      <div class="subject-card" data-subject="Physics 2nd Paper" onclick="selectSubject('Physics 2nd Paper')">
        <div class="subject-icon">üî≠</div>
        <h3>Physics 2nd Paper</h3>
      </div>
      <div class="subject-card" data-subject="Biology 1st Paper" onclick="selectSubject('Biology 1st Paper')">
        <div class="subject-icon">üß¨</div>
        <h3>Biology 1st Paper</h3>
      </div>
      <div class="subject-card" data-subject="Biology 2nd Paper" onclick="selectSubject('Biology 2nd Paper')">
        <div class="subject-icon">üåø</div>
        <h3>Biology 2nd Paper</h3>
      </div>
      <div class="subject-card" data-subject="Chemistry 1st Paper" onclick="selectSubject('Chemistry 1st Paper')">
        <div class="subject-icon">üß™</div>
        <h3>Chemistry 1st Paper</h3>
      </div>
      <div class="subject-card" data-subject="Chemistry 2nd Paper" onclick="selectSubject('Chemistry 2nd Paper')">
        <div class="subject-icon">‚öóÔ∏è</div>
        <h3>Chemistry 2nd Paper</h3>
      </div>
      <div class="subject-card" data-subject="Information and Communication Technology" onclick="selectSubject('Information and Communication Technology')">
        <div class="subject-icon">üíª</div>
        <h3>ICT</h3>
      </div>
    </div>
    
    <div class="history-preview">
      <h3>Recent History</h3>
      <div class="history-scroll" id="historyScroll">
        <!-- History items will be added here dynamically -->
      </div>
      <button class="btn" onclick="showHistory()" style="margin-top: 15px;">View All History</button>
    </div>
    
    <div class="analysis-container">
      <h3>Subject Analysis</h3>
      <div class="time-filter">
        <button class="active" onclick="filterAnalysis('all')">All Time</button>
        <button onclick="filterAnalysis('year')">Yearly</button>
        <button onclick="filterAnalysis('month')">Monthly</button>
        <button onclick="filterAnalysis('week')">Weekly</button>
      </div>
      <div class="chart-container" id="chartContainer">
        <!-- Chart will be rendered here -->
      </div>
    </div>
  </div>
  
  <div id="setupForm" style="display: none;">
    <button class="btn btn-secondary back-btn" onclick="goBackToHome()">‚Üê Back</button>
    <h1>Markora - <span id="subjectTitle"></span></h1>
    
    <div class="form-group">
      <label for="testTitle">Test Title:</label>
      <input type="text" id="testTitle" placeholder="Enter test title" />
    </div>
    
    <div class="form-group">
      <label for="startNum">Start Serial:</label>
      <input type="number" id="startNum" min="1" />
    </div>
    
    <div class="form-group">
      <label for="endNum">End Serial:</label>
      <input type="number" id="endNum" min="1" />
    </div>
    
    <div class="form-group">
      <label for="timePerQuestion">Time per Question (seconds):</label>
      <input type="number" id="timePerQuestion" min="10" value="60" />
    </div>
    
    <div class="controls">
      <button class="btn" onclick="startTest()">Start Test</button>
      <button class="btn btn-secondary" onclick="showHistory()">View History</button>
    </div>
  </div>

  <div id="timer" style="display: none;"></div>
  
  <div id="progressContainer" class="progress-container" style="display: none;">
    <div id="progressBar" class="progress-bar"></div>
  </div>

  <div id="questionContainer"></div>

  <div class="controls" id="testControls" style="display: none;">
    <button class="btn btn-success" onclick="submitAnswers()">Submit Answers</button>
    <button class="btn btn-danger" onclick="cancelTest()">Cancel Test</button>
    <button class="btn btn-secondary" onclick="saveForLater()">Save for Later</button>
  </div>
  
  <div id="resultStats" style="display: none;">
    <div class="stats">
      <div class="stat-item">
        <div>Total Questions</div>
        <div class="stat-value" id="totalQuestions">0</div>
      </div>
      <div class="stat-item">
        <div>Correct Answers</div>
        <div class="stat-value" id="correctAnswers">0</div>
      </div>
      <div class="stat-item">
        <div>Score</div>
        <div class="stat-value" id="scorePercentage">0%</div>
      </div>
    </div>
    <div class="controls">
      <button class="btn" onclick="goBackToHome()">Back to Home</button>
      <button class="btn btn-secondary" onclick="showHistory()">View History</button>
    </div>
  </div>
</div>

<!-- Modal for various purposes -->
<div class="modal" id="modal">
  <div class="modal-content" id="modalContent">
    <!-- content dynamically added -->
  </div>
</div>

<!-- History Modal -->
<div class="modal" id="historyModal">
  <div class="modal-content">
    <h3>Test History - <span id="historySubjectTitle"></span></h3>
    
    <div class="filter-controls">
      <select id="filterSubject" onchange="filterHistory()">
        <option value="all">All Subjects</option>
        <option value="English 1st Paper">English 1st Paper</option>
        <option value="English 2nd Paper">English 2nd Paper</option>
        <option value="Bengali 1st Paper">Bengali 1st Paper</option>
        <option value="Bengali 2nd Paper">Bengali 2nd Paper</option>
        <option value="Mathematics 1st Paper">Mathematics 1st Paper</option>
        <option value="Mathematics 2nd Paper">Mathematics 2nd Paper</option>
        <option value="Physics 1st Paper">Physics 1st Paper</option>
        <option value="Physics 2nd Paper">Physics 2nd Paper</option>
        <option value="Biology 1st Paper">Biology 1st Paper</option>
        <option value="Biology 2nd Paper">Biology 2nd Paper</option>
        <option value="Chemistry 1st Paper">Chemistry 1st Paper</option>
        <option value="Chemistry 2nd Paper">Chemistry 2nd Paper</option>
        <option value="Information and Communication Technology">ICT</option>
      </select>
      
      <select id="filterStatus" onchange="filterHistory()">
        <option value="all">All Status</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
      </select>
      
      <select id="filterSort" onchange="filterHistory()">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="highest">Highest Score</option>
        <option value="lowest">Lowest Score</option>
      </select>
      
      <input type="text" id="searchTitle" placeholder="Search by title" oninput="filterHistory()">
    </div>
    
    <div id="historyList" style="max-height: 400px; overflow-y: auto;"></div>
    <div class="modal-buttons">
      <button class="btn" onclick="closeHistoryModal()">Close</button>
    </div>
  </div>
</div>

<footer class="footer">
  Developed by <span class="footer-name">thedhannomorich</span>.
  Support the developer by sending feedback at this email: 
  <span class="footer-email" id="copyEmail">thedhannomorich@gmail.com</span>
</footer>

<script>
// Application state
const state = {
  answers: {},
  correctAnswers: {},
  totalQuestions: 0,
  timer: null,
  timeLeft: 0,
  testTitle: '',
  testSubject: '',
  testStarted: false,
  currentQuestionSet: []
};

// DOM elements
const elements = {
  homeScreen: document.getElementById('homeScreen'),
  setupForm: document.getElementById('setupForm'),
  subjectTitle: document.getElementById('subjectTitle'),
  timer: document.getElementById('timer'),
  questionContainer: document.getElementById('questionContainer'),
  testControls: document.getElementById('testControls'),
  resultStats: document.getElementById('resultStats'),
  progressContainer: document.getElementById('progressContainer'),
  progressBar: document.getElementById('progressBar'),
  historySubjectTitle: document.getElementById('historySubjectTitle'),
  themeToggle: document.getElementById('themeToggle'),
  historyScroll: document.getElementById('historyScroll'),
  chartContainer: document.getElementById('chartContainer')
};

// Initialize the app
function init() {
  loadRecentHistory();
  renderSubjectAnalysis();
  startHistoryScroll();
}

// Auto-scroll for history preview
function startHistoryScroll() {
  let scrollPosition = 0;
  const scrollContainer = elements.historyScroll;
  const scrollWidth = scrollContainer.scrollWidth;
  
  setInterval(() => {
    scrollPosition += 1;
    if (scrollPosition > scrollWidth) {
      scrollPosition = 0;
      setTimeout(() => {
        scrollContainer.scrollTo({ left: 0, behavior: 'instant' });
      }, 1000);
    }
    scrollContainer.scrollTo({ left: scrollPosition, behavior: 'smooth' });
  }, 50);
}

// Load recent history for preview
function loadRecentHistory() {
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  history = history.slice(0, 5); // Get last 5 tests
  
  elements.historyScroll.innerHTML = '';
  
  if (history.length === 0) {
    elements.historyScroll.innerHTML = '<p>No recent tests found.</p>';
    return;
  }
  
  history.forEach(test => {
    const testDiv = document.createElement('div');
    testDiv.className = 'history-item';
    testDiv.innerHTML = `
      <h4>${test.title}</h4>
      <p>${test.subject}</p>
      <p>${test.date}</p>
      ${test.score !== null ? `<p><strong>Score:</strong> ${test.score}%</p>` : '<p>Pending</p>'}
    `;
    testDiv.addEventListener('click', () => viewTestDetails(test));
    elements.historyScroll.appendChild(testDiv);
  });
}

// Updated renderSubjectAnalysis function
function renderSubjectAnalysis(filter = 'all') {
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  
  // Filter by time if needed
  const now = new Date();
  if (filter === 'year') {
    history = history.filter(test => {
      const testDate = new Date(test.date);
      return now.getFullYear() === testDate.getFullYear();
    });
  } else if (filter === 'month') {
    history = history.filter(test => {
      const testDate = new Date(test.date);
      return now.getFullYear() === testDate.getFullYear() && 
             now.getMonth() === testDate.getMonth();
    });
  } else if (filter === 'week') {
    history = history.filter(test => {
      const testDate = new Date(test.date);
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      return testDate >= oneWeekAgo;
    });
  }
  
  // Group by subject and calculate average scores
  const subjects = [
    'English 1st Paper', 'English 2nd Paper',
    'Bengali 1st Paper', 'Bengali 2nd Paper',
    'Mathematics 1st Paper', 'Mathematics 2nd Paper',
    'Physics 1st Paper', 'Physics 2nd Paper',
    'Biology 1st Paper', 'Biology 2nd Paper',
    'Chemistry 1st Paper', 'Chemistry 2nd Paper',
    'Information and Communication Technology'
  ];
  
  const subjectData = {};
  subjects.forEach(subject => {
    const subjectTests = history.filter(test => test.subject === subject && test.score !== null);
    if (subjectTests.length > 0) {
      const totalScore = subjectTests.reduce((sum, test) => sum + test.score, 0);
      subjectData[subject] = Math.round(totalScore / subjectTests.length);
    } else {
      subjectData[subject] = 0;
    }
  });
  
  // Render chart
  elements.chartContainer.innerHTML = '';
  
  const maxScore = Math.max(...Object.values(subjectData), 100) || 100;
  const chartHeight = 250;
  
  subjects.forEach(subject => {
    const score = subjectData[subject] || 0;
    const barHeight = (score / maxScore) * chartHeight;
    
    const barContainer = document.createElement('div');
    barContainer.className = 'bar-container';
    barContainer.style.height = `${chartHeight}px`;
    
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = `${barHeight}px`;
    bar.style.backgroundColor = getSubjectColor(subject);
    bar.title = `${subject}: ${score}%`;
    if (score > 0) {
      bar.textContent = score;
    }
    
    const label = document.createElement('div');
    label.className = 'chart-label';
    label.textContent = subject.split(' ').slice(0, 2).join(' '); // Show subject and paper number
    
    barContainer.appendChild(bar);
    barContainer.appendChild(label);
    elements.chartContainer.appendChild(barContainer);
  });
}

function getSubjectColor(subject) {
  const colors = {
    'English 1st Paper': '#3a506b',
    'English 2nd Paper': '#3a506b',
    'Bengali 1st Paper': '#5d5179',
    'Bengali 2nd Paper': '#5d5179',
    'Mathematics 1st Paper': '#6a4c93',
    'Mathematics 2nd Paper': '#6a4c93',
    'Physics 1st Paper': '#1982c4',
    'Physics 2nd Paper': '#1982c4',
    'Biology 1st Paper': '#8ac926',
    'Biology 2nd Paper': '#8ac926',
    'Chemistry 1st Paper': '#ff595e',
    'Chemistry 2nd Paper': '#ff595e',
    'Information and Communication Technology': '#ffca3a'
  };
  return colors[subject] || '#444';
}

function filterAnalysis(filter) {
  // Update active button
  document.querySelectorAll('.time-filter button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  renderSubjectAnalysis(filter);
}

function selectSubject(subject) {
  state.testSubject = subject;
  elements.subjectTitle.textContent = subject;
  elements.homeScreen.style.display = 'none';
  elements.setupForm.style.display = 'block';
}

function goBackToHome() {
  if (state.testStarted) {
    showModal('Are you sure you want to cancel this test?', 
      () => {
        clearInterval(state.timer);
        resetToHome();
      }
    );
  } else {
    resetToHome();
  }
}

function resetToHome() {
  elements.homeScreen.style.display = 'block';
  elements.setupForm.style.display = 'none';
  elements.timer.style.display = 'none';
  elements.testControls.style.display = 'none';
  elements.progressContainer.style.display = 'none';
  elements.questionContainer.innerHTML = '';
  elements.resultStats.style.display = 'none';
  state.testStarted = false;
}

function startTest() {
  // Validate inputs
  state.testTitle = document.getElementById('testTitle').value.trim();
  if (!state.testTitle) {
    showModal('Please enter a test title!');
    return;
  }

  const start = parseInt(document.getElementById('startNum').value);
  const end = parseInt(document.getElementById('endNum').value);
  const timePerQuestion = parseInt(document.getElementById('timePerQuestion').value) || 60;
  
  if (isNaN(start) || isNaN(end) || end < start) {
    showModal('Please enter valid serial numbers!');
    return;
  }

  // Initialize test state
  state.totalQuestions = end - start + 1;
  state.timeLeft = state.totalQuestions * timePerQuestion;
  state.answers = {};
  state.correctAnswers = {};
  state.currentQuestionSet = Array.from({length: end - start + 1}, (_, i) => start + i);
  state.testStarted = true;

  // Update UI
  elements.setupForm.style.display = 'none';
  elements.timer.style.display = 'block';
  elements.testControls.style.display = 'flex';
  elements.progressContainer.style.display = 'block';
  elements.questionContainer.innerHTML = '';
  elements.resultStats.style.display = 'none';

  // Create question elements
  state.currentQuestionSet.forEach(qNum => {
    const div = document.createElement('div');
    div.className = 'question';
    div.id = `q-${qNum}`;
    div.innerHTML = `
      <div class="question-number">Question ${qNum}</div>
      <div class="options-container">
        <button class="option-btn" onclick="selectAnswer(${qNum}, '‡¶ï', this)">‡¶ï</button>
        <button class="option-btn" onclick="selectAnswer(${qNum}, '‡¶ñ', this)">‡¶ñ</button>
        <button class="option-btn" onclick="selectAnswer(${qNum}, '‡¶ó', this)">‡¶ó</button>
        <button class="option-btn" onclick="selectAnswer(${qNum}, '‡¶ò', this)">‡¶ò</button>
      </div>
    `;
    elements.questionContainer.appendChild(div);
  });

  updateTimer();
  updateProgress();
  clearInterval(state.timer);
  state.timer = setInterval(updateTimer, 1000);
}

function selectAnswer(qNum, ans, btn) {
  state.answers[qNum] = ans;
  
  // Clear previous selection and highlight new one
  const questionDiv = btn.closest('.question');
  const buttons = questionDiv.querySelectorAll('.option-btn');
  buttons.forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  
  updateProgress();
}

function updateTimer() {
  if (state.timeLeft <= 0) {
    clearInterval(state.timer);
    showModal('Time is up!');
    submitAnswers();
    return;
  }
  
  const minutes = Math.floor(state.timeLeft / 60);
  const seconds = state.timeLeft % 60;
  elements.timer.innerHTML = `Time Remaining: <span style="color: ${state.timeLeft <= 60 ? 'red' : 'var(--primary-color)'}">${minutes}:${seconds < 10 ? '0' : ''}${seconds}</span>`;
  state.timeLeft--;
}

function updateProgress() {
  const answered = Object.keys(state.answers).length;
  const percentage = Math.round((answered / state.totalQuestions) * 100);
  elements.progressBar.style.width = `${percentage}%`;
  elements.progressBar.textContent = `${percentage}%`;
}

function submitAnswers() {
  clearInterval(state.timer);
  state.testStarted = false;
  
  showModal('Are you ready to provide the correct answers?', 
    () => {
      // Show UI for entering correct answers
      elements.questionContainer.innerHTML = '';
      state.currentQuestionSet.forEach(qNum => {
        const div = document.createElement('div');
        div.className = 'question';
        div.id = `q-${qNum}`;
        div.innerHTML = `
          <div class="question-number">Correct Answer for Question ${qNum}</div>
          <div class="options-container">
            <button class="option-btn" onclick="selectCorrect(${qNum}, '‡¶ï', this)">‡¶ï</button>
            <button class="option-btn" onclick="selectCorrect(${qNum}, '‡¶ñ', this)">‡¶ñ</button>
            <button class="option-btn" onclick="selectCorrect(${qNum}, '‡¶ó', this)">‡¶ó</button>
            <button class="option-btn" onclick="selectCorrect(${qNum}, '‡¶ò', this)">‡¶ò</button>
          </div>
        `;
        elements.questionContainer.appendChild(div);
      });
      
      elements.testControls.innerHTML = `
        <button class="btn btn-success" onclick="checkAnswers()">Check Answers</button>
        <button class="btn btn-warning" onclick="saveForLater()">Save for Later</button>
      `;
    },
    () => {
      // User chose not to provide correct answers
      saveForLater();
    }
  );
}

function selectCorrect(qNum, ans, btn) {
  state.correctAnswers[qNum] = ans;
  
  const questionDiv = btn.closest('.question');
  const buttons = questionDiv.querySelectorAll('.option-btn');
  buttons.forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

function checkAnswers() {
  let correctCount = 0;
  
  state.currentQuestionSet.forEach(qNum => {
    const questionDiv = document.getElementById(`q-${qNum}`);
    const userAnswer = state.answers[qNum];
    const correctAnswer = state.correctAnswers[qNum];
    
    if (userAnswer === correctAnswer) {
      correctCount++;
      questionDiv.classList.add('correct');
    } else {
      questionDiv.classList.add('mistake');
    }
  });
  
  // Calculate and display results
  const score = Math.round((correctCount / state.totalQuestions) * 100);
  document.getElementById('totalQuestions').textContent = state.totalQuestions;
  document.getElementById('correctAnswers').textContent = correctCount;
  document.getElementById('scorePercentage').textContent = `${score}%`;
  
  elements.resultStats.style.display = 'block';
  elements.testControls.style.display = 'none';
  elements.timer.style.display = 'none';
  elements.progressContainer.style.display = 'none';
  
  saveToHistory('completed', state.answers, state.correctAnswers, state.totalQuestions, score);
  
  showModal(`Your score: ${correctCount} / ${state.totalQuestions} (${score}%)`);
}

function saveForLater() {
  saveToHistory('pending', state.answers, {}, state.totalQuestions, null);
  showModal('Your answers have been saved for future reference!');
  resetToHome();
}

function cancelTest() {
  showModal('Are you sure you want to cancel this test?', 
    () => {
      clearInterval(state.timer);
      resetToHome();
    }
  );
}

function saveToHistory(status, answers, corrects, total, score) {
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  history.unshift({
    title: state.testTitle,
    subject: state.testSubject,
    date: new Date().toLocaleString(),
    status: status,
    answers: answers,
    correctAnswers: corrects,
    total: total,
    score: score,
    questionSet: state.currentQuestionSet
  });
  localStorage.setItem('omrHistory', JSON.stringify(history));
  loadRecentHistory();
  renderSubjectAnalysis();
}

function showHistory() {
  const history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  const filteredHistory = history; // No filters here
  displayHistory(filteredHistory);
  document.getElementById('historyModal').style.display = 'flex';
}

// Updated filterHistory function
function filterHistory() {
  const subjectFilter = document.getElementById('filterSubject').value;
  const statusFilter = document.getElementById('filterStatus').value;
  const sortFilter = document.getElementById('filterSort').value;
  const searchTerm = document.getElementById('searchTitle').value.toLowerCase();
  
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  
  // Apply filters
  let filteredHistory = history.filter(test => {
    // Subject filter
    const subjectMatch = subjectFilter === 'all' || test.subject === subjectFilter;
    
    // Status filter
    let statusMatch = true;
    if (statusFilter === 'completed') {
      statusMatch = test.status === 'completed';
    } else if (statusFilter === 'pending') {
      statusMatch = test.status === 'pending';
    }
    
    // Search filter
    const searchMatch = test.title.toLowerCase().includes(searchTerm) || 
                       test.subject.toLowerCase().includes(searchTerm);
    
    return subjectMatch && statusMatch && searchMatch;
  });
  
  // Apply sorting
  switch(sortFilter) {
    case 'newest':
      filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
      break;
    case 'oldest':
      filteredHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
      break;
    case 'highest':
      filteredHistory.sort((a, b) => {
        // Handle cases where score might be null
        const aScore = a.score !== null ? a.score : -1;
        const bScore = b.score !== null ? b.score : -1;
        return bScore - aScore;
      });
      break;
    case 'lowest':
      filteredHistory.sort((a, b) => {
        // Handle cases where score might be null
        const aScore = a.score !== null ? a.score : Infinity;
        const bScore = b.score !== null ? b.score : Infinity;
        return aScore - bScore;
      });
      break;
  }
  
  displayHistory(filteredHistory);
}

function displayHistory(history) {
  const historyList = document.getElementById('historyList');
  historyList.innerHTML = '';
  
  if (history.length === 0) {
    historyList.innerHTML = '<p>No matching tests found.</p>';
  } else {
    history.forEach((test, index) => {
      const testDiv = document.createElement('div');
      testDiv.style.padding = '10px';
      testDiv.style.borderBottom = '1px solid #444';
      testDiv.style.cursor = 'pointer';
      
      let statusColor = '#6c757d';
      if (test.status === 'completed') statusColor = 'var(--success-color)';
      else if (test.status === 'pending') statusColor = 'var(--warning-color)';
      
      testDiv.innerHTML = `
        <div style="font-weight: bold;">${test.title}</div>
        <div style="font-size: 0.9em; color: #aaa;">${test.subject} ‚Ä¢ ${test.date}</div>
        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
          <span style="color: ${statusColor}">${test.status.toUpperCase()}</span>
          ${test.score !== null ? `<span style="font-weight: bold;">Score: ${test.score}%</span>` : ''}
        </div>
      `;
      
      testDiv.addEventListener('click', () => viewTestDetails(test));
      historyList.appendChild(testDiv);
    });
  }
}

function viewTestDetails(test) {
  let content = `
    <h3>${test.title}</h3>
    <p><strong>Subject:</strong> ${test.subject}</p>
    <p><strong>Date:</strong> ${test.date}</p>
    <p><strong>Status:</strong> ${test.status}</p>
    ${test.score !== null ? `<p><strong>Score:</strong> ${test.score}%</p>` : ''}
    <p><strong>Questions:</strong> ${test.questionSet[0]} to ${test.questionSet[test.questionSet.length - 1]}</p>
  `;
  
  if (test.status === 'completed') {
    content += `<div style="max-height: 300px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
      <h4>Question Details</h4>
      <table style="width: 100%; border-collapse: collapse;">
        <tr style="background: #444;">
          <th style="padding: 8px; text-align: left;">Question</th>
          <th style="padding: 8px; text-align: left;">Your Answer</th>
          <th style="padding: 8px; text-align: left;">Correct Answer</th>
        </tr>`;
    
    test.questionSet.forEach(qNum => {
      const userAns = test.answers[qNum] || 'Not answered';
      const correctAns = test.correctAnswers[qNum] || '-';
      const isCorrect = userAns === correctAns;
      
      content += `
        <tr style="border-bottom: 1px solid #444; background: ${isCorrect ? '#2a3a2a' : '#442a2a'}">
          <td style="padding: 8px;">${qNum}</td>
          <td style="padding: 8px;">${userAns}</td>
          <td style="padding: 8px;">${correctAns}</td>
        </tr>
      `;
    });
    
    content += `</table></div>`;
  }
  
  showModal(content);
  closeHistoryModal();
}

function closeHistoryModal() {
  document.getElementById('historyModal').style.display = 'none';
}

// Modal functions
function showModal(message, onConfirm, onCancel) {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  
  content.innerHTML = `<p>${message}</p>`;
  
  if (onConfirm || onCancel) {
    const buttons = document.createElement('div');
    buttons.className = 'modal-buttons';
    
    if (onConfirm) {
      buttons.innerHTML += `<button class="btn" onclick="closeModal(true)">Yes</button>`;
    }
    if (onCancel) {
      buttons.innerHTML += `<button class="btn btn-secondary" onclick="closeModal(false)">No</button>`;
    }
    
    content.appendChild(buttons);
    
    // Store callbacks as data attributes
    modal.dataset.onConfirm = onConfirm ? onConfirm.toString() : '';
    modal.dataset.onCancel = onCancel ? onCancel.toString() : '';
  } else {
    content.innerHTML += `<div class="modal-buttons">
      <button class="btn" onclick="closeModal()">OK</button>
    </div>`;
  }
  
  modal.style.display = 'flex';
}

function closeModal(confirmed) {
  const modal = document.getElementById('modal');
  modal.style.display = 'none';
  
  if (confirmed === true && modal.dataset.onConfirm) {
    eval('(' + modal.dataset.onConfirm + ')')();
  } else if (confirmed === false && modal.dataset.onCancel) {
    eval('(' + modal.dataset.onCancel + ')')();
  }
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDark);
  elements.themeToggle.textContent = isDark ? 'üåû' : 'üåì';
}

// Initialize dark mode if previously set
if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark-mode');
  elements.themeToggle.textContent = 'üåû';
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
  document.getElementById('copyEmail').addEventListener('click', function() {
    const email = this.textContent;
    navigator.clipboard.writeText(email).then(() => {
      // Show a quick feedback (optional)
      const originalText = this.textContent;
      this.textContent = 'Copied!';
      setTimeout(() => this.textContent = originalText, 1500);
    }).catch(() => {
      alert('Failed to copy email. Please copy manually.');
    });
  });
</script>
</body>
</html>

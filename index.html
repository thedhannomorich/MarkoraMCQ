<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gravithon</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px);}
  to { opacity: 1; transform: translateY(0);}
}
@keyframes scaleIn {
  0% { opacity: 0; transform: scale(0.98);}
  100% { opacity: 1; transform: scale(1);}
}
@keyframes gradientMove {
  0% {background-position:0% 50%;}
  50% {background-position:100% 50%;}
  100% {background-position:0% 50%;}
}
@keyframes pulse {
  0%, 100% { transform: scale(1);}
  50% { transform: scale(1.05);}
}
@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important;}
}
:root {
  --primary-color: #fff;
  --secondary-color: #aaa;
  --dark-bg: #121212;
  --dark-card: #1e1e1e;
  --dark-text-color: #f0f0f0;
  --bangla-font: 'Hind Siliguri', sans-serif;
  --english-font: 'Poppins', sans-serif;
  --border-radius: 0.625rem;
  --min-touch-size: 48px;
  /* Individual Gradients */
  --accent-gradient: linear-gradient(90deg, #b1ff8a 0%, #24c96b 100%);
  --success-gradient: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
  --error-gradient: linear-gradient(90deg, #ff5858 0%, #f857a6 100%);
  --warning-gradient: linear-gradient(90deg, #ffb347 0%, #ff774e 100%);
  --option-gradient: linear-gradient(120deg, #5ee7df 0%, #3a8dde 100%);
  --secondary-gradient: linear-gradient(90deg, #434343 0%, #262626 100%);
}
* { -webkit-tap-highlight-color: transparent; box-sizing: border-box;}
body {
  font-family: var(--bangla-font);
  margin: 0;
  background: var(--dark-bg);
  color: var(--dark-text-color);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  user-select: text;
  touch-action: manipulation;
}
h1 {
  color: var(--primary-color);
  text-align: center;
  margin-bottom: 1rem;
  font-family: var(--english-font);
  font-weight: 700;
  letter-spacing: 1px;
}
h2, h3 {
  color: var(--primary-color);
  text-align: center;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid #24c96b;
  padding-bottom: 0.625rem;
  font-weight: 700;
}

/* Containers */
.container,
.question,
.subject-card,
.modal-content,
.stat-item,
.instructions,
.history-preview,
.analysis-container {
  background: var(--dark-card);
  color: var(--dark-text-color);
  border-radius: var(--border-radius);
  box-shadow: 0 0.25rem 0.9375rem rgba(0, 0, 0, 0.3);
  animation: fadeIn 0.4s ease;
  animation-fill-mode: both;
  padding: 1.5rem;
}
.container { max-width: 62.5rem; margin: 1.25rem auto; padding: 1.5rem;}

/* Inputs */
input[type="text"], input[type="number"], select {
  width: 100%;
  padding: 0.75rem;
  background: #2c2c2c;
  border: 1px solid #444;
  border-radius: var(--border-radius);
  color: var(--dark-text-color);
  font-size: 1rem;
  font-family: var(--bangla-font);
  outline-offset: 2px;
  transition: border-color 0.2s ease;
  min-height: var(--min-touch-size);
}
input[type="text"]:invalid, input[type="number"]:invalid { border-color: #f857a6;}
input[type="text"]:focus, input[type="number"]:focus, select:focus {
  border-color: #24c96b;
  outline: 2px solid #24c96b;
}
label { font-weight: 700; margin-bottom: 0.5rem; display: block; font-size: 1rem; }

/* Buttons - Gradients & Animation */
.btn,
.option-btn,
.theme-toggle {
  font-weight: 700;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s, background 0.5s;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  min-width: var(--min-touch-size);
  min-height: var(--min-touch-size);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.75rem 1.25rem;
  font-size: 1rem;
  color: #fff;
  background: var(--accent-gradient);
  background-size: 200% 200%;
  animation: gradientMove 3s linear infinite;
  box-shadow: 0 2px 8px #24c96b22;
}
.btn:hover:not(:disabled),
.option-btn:hover:not(:disabled),
.theme-toggle:hover:not(:disabled) {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 0.5rem 1.5rem #24c96b33;
}
.btn:active:not(:disabled),
.option-btn:active:not(:disabled),
.theme-toggle:active:not(:disabled) {
  transform: translateY(0) scale(0.98);
  animation: pulse 0.2s;
}
.btn:disabled { opacity: 0.7; cursor: not-allowed; }
/* Button variants - gradients */
.btn-secondary {
  background: var(--secondary-gradient);
  color: #fff;
  background-size: 200% 200%;
  animation: gradientMove 6s linear infinite;
}
.btn-success {
  background: var(--success-gradient);
  color: #fff;
  background-size: 200% 200%;
  animation: gradientMove 4s linear infinite;
}
.btn-danger {
  background: var(--error-gradient);
  color: #fff;
  background-size: 200% 200%;
  animation: gradientMove 4s linear infinite;
}
.btn-warning {
  background: var(--warning-gradient);
  color: #fff;
  background-size: 200% 200%;
  animation: gradientMove 4s linear infinite;
}

/* Timer */
#timer {
  position: fixed;
  top: 1.25rem;
  right: 1.25rem;
  background: #2c2c2c;
  color: var(--primary-color);
  padding: 0.75rem 1rem;
  border-radius: var(--border-radius);
  font-weight: 700;
  font-size: 1rem;
  z-index: 100;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
#timer.warning {
  color: #ffb347;
  animation: pulse 1s infinite;
}
#timer.critical {
  color: #ff5858;
  animation: pulse 0.5s infinite;
}

/* Question grid */
#questionContainer {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));
  gap: 1.25rem;
  margin: 1.5rem 0;
}
.question {
  border: 1px solid #333;
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  min-height: 12rem;
  font-size: 1rem;
  user-select: none;
  transition: transform 0.2s;
  background: var(--dark-card);
  color: var(--dark-text-color);
  animation: fadeIn 0.4s;
}
.question-number {
  color: #24c96b;
  font-weight: 700;
  margin-bottom: 0.75rem;
  font-size: 1.1rem;
}
.options-container {
  display: flex;
  flex-wrap: wrap;
  margin-top: auto;
  gap: 0.75rem;
  justify-content: center;
}
.option-btn {
  width: 3rem;
  height: 3rem;
  border: 2px solid #666;
  background: var(--option-gradient);
  background-size: 200% 200%;
  color: #fff;
  font-weight: 700;
  font-size: 1.1rem;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.2s, background 0.5s;
  border-radius: 50%;
  animation: gradientMove 6s ease-in-out infinite;
}
.option-btn.selected {
  background: var(--accent-gradient);
  color: #000;
  border-color: #24c96b;
  transform: scale(1.1);
  animation: gradientMove 2s linear infinite;
}
.question.mistake {
  border: 2px solid #f857a6;
  background: var(--error-gradient);
  background-size: 200% 200%;
  background-blend-mode: lighten;
  color: #fff;
  animation: gradientMove 2s linear infinite, fadeIn 0.5s;
}
.question.correct {
  border: 2px solid #43e97b;
  background: var(--success-gradient);
  background-size: 200% 200%;
  background-blend-mode: lighten;
  color: #fff;
  animation: gradientMove 2s linear infinite, fadeIn 0.5s;
}

/* Controls */
.controls {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin: 1.5rem 0;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 1rem;
  backdrop-filter: blur(5px);
}
.modal-content {
  max-width: min(90vw, 35rem);
  width: 100%;
  padding: 1.5rem;
  text-align: center;
  animation: scaleIn 0.3s;
  position: relative;
  max-height: 90vh;
  overflow-y: auto;
}
.modal-close {
  position: absolute;
  top: 0.5rem; right: 0.5rem;
  background: transparent;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--secondary-color);
  width: 2.5rem; height: 2.5rem;
  display: flex; align-items: center; justify-content: center;
}
.modal-buttons {
  display: flex; justify-content: center; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap;
}

/* Progress bar */
.progress-container {
  background: #333;
  border-radius: var(--border-radius);
  margin: 1.5rem 0;
  height: 1.5rem;
  overflow: hidden;
  position: relative;
}
.progress-bar {
  height: 100%;
  width: 0%;
  background: var(--accent-gradient);
  background-size: 200% 200%;
  animation: gradientMove 4s linear infinite;
  border-radius: var(--border-radius);
  text-align: center;
  font-size: 0.85rem;
  color: #000;
  font-weight: bold;
  transition: width 0.3s;
  display: flex; align-items: center; justify-content: center;
}

/* Stats */
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}
.stat-item { text-align: center; padding: 1rem;}
.stat-value {
  font-size: 1.75rem;
  background: var(--accent-gradient);
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
  font-weight: bold;
  margin: 0.5rem 0;
  animation: gradientMove 8s linear infinite;
}

/* Subject grid */
.subject-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
  gap: 1.25rem;
  margin: 2rem 0;
}
.subject-card {
  display: flex; flex-direction: column; align-items: center;
  padding: 1.5rem 1rem;
  cursor: pointer; min-height: 9rem;
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative; overflow: hidden;
  background: var(--dark-card);
  color: var(--dark-text-color);
}
.subject-card::after {
  content: '';
  position: absolute; bottom: 0; left: 0;
  width: 100%; height: 4px;
  background: var(--accent-gradient);
  background-size: 200% 200%;
  animation: gradientMove 3s linear infinite;
  transform: scaleX(0); transform-origin: left;
  transition: transform 0.3s;
}
.subject-card:hover::after,
.subject-card:focus-visible::after {
  transform: scaleX(1);
}
.subject-card:hover,
.subject-card:focus-visible {
  transform: translateY(-0.25rem) scale(1.05);
  box-shadow: 0 0.5rem 1.25rem #24c96b44;
  outline: none;
}
.subject-icon { font-size: 2rem; margin-bottom: 0.75rem; }
.subject-card h3 {
  margin: 0;
  font-size: 1.1rem;
  text-align: center;
  border-bottom: none;
  padding-bottom: 0;
}

/* Filter controls */
.filter-controls {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}
.filter-controls select, .filter-controls input { width: 100%; min-width: auto; }

/* Theme toggle */
.theme-toggle {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  background: var(--accent-gradient);
  background-size: 200% 200%;
  color: #fff;
  width: 3.5rem;
  height: 3.5rem;
  border-radius: 50%;
  font-size: 1.5rem;
  box-shadow: 0 0.25rem 0.75rem #24c96b33;
  z-index: 100;
  border: none;
  animation: gradientMove 3s linear infinite;
}

/* Instructions */
.instructions ul { padding-left: 1.25rem; font-size: 1rem; line-height: 1.7;}
.instructions li { margin-bottom: 0.5rem; }

/* History preview */
.history-scroll {
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  padding: 0.75rem 0;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: #24c96b var(--dark-card);
}
.history-scroll::-webkit-scrollbar { height: 6px;}
.history-scroll::-webkit-scrollbar-track { background: var(--dark-card);}
.history-scroll::-webkit-scrollbar-thumb {
  background: #24c96b;
  border-radius: 3px;
}
.history-item {
  min-width: 14rem;
  background: #333;
  border-radius: var(--border-radius);
  padding: 1rem;
  flex-shrink: 0;
  transition: transform 0.2s;
  background: var(--option-gradient);
  background-size: 200% 200%;
  animation: gradientMove 9s linear infinite;
  color: #fff;
}
.history-item:hover { transform: translateY(-3px); }

/* Analysis container */
.analysis-container { margin: 2rem 0; }

/* Chart styles */
.chart-container {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  height: 18rem;
  padding: 1.5rem 0;
  overflow-x: auto;
  position: relative;
}
.bar-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0 0.5rem;
  height: 100%;
  min-width: 3rem;
}
.bar {
  width: 2rem;
  margin: 0 auto;
  position: relative;
  transition: height 0.5s;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 0.75rem;
  border-radius: 0.25rem 0.25rem 0 0;
  background: var(--accent-gradient);
  background-size: 200% 200%;
  animation: gradientMove 3s linear infinite;
}
.chart-label {
  margin-top: 0.5rem;
  text-align: center;
  font-size: 0.7rem;
  white-space: nowrap;
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  height: 5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Time filter buttons */
.time-filter {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
  justify-content: center;
}
.time-filter button {
  background: var(--secondary-gradient);
  border: none;
  border-radius: var(--border-radius);
  padding: 0.75rem 1rem;
  color: #fff;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 5rem;
  background-size: 200% 200%;
  animation: gradientMove 7s linear infinite;
}
.time-filter button.active {
  background: var(--accent-gradient);
  color: #000;
  font-weight: bold;
  animation: gradientMove 2.5s linear infinite;
}

/* Form validation */
.error-message {
  color: #f857a6;
  font-size: 0.85rem;
  margin-top: 0.25rem;
  display: none;
}
.input-error { border-color: #f857a6 !important; }

/* Footer */
footer {
  background: var(--dark-card);
  color: var(--dark-text-color);
  text-align: center;
  padding: 1.5rem 1rem;
  margin-top: 2rem;
  border-top: 1px solid #333;
}
.footer-email {
  background: var(--accent-gradient);
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
  text-decoration: underline;
  cursor: pointer;
  transition: color 0.2s;
  animation: gradientMove 6s linear infinite;
}
.footer-email:hover {
  background: linear-gradient(90deg, #b1ff8a 0%, #24c96b 100%);
  -webkit-background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
  text-decoration: underline;
}

/* Responsive */
@media (max-width: 768px) {
  .container { padding: 1rem; margin: 0.75rem;}
  #questionContainer { grid-template-columns: 1fr;}
  .option-btn { width: 2.75rem; height: 2.75rem; font-size: 1rem;}
  .subject-grid { grid-template-columns: repeat(auto-fill, minmax(10rem, 1fr));}
  .filter-controls { grid-template-columns: 1fr;}
  .modal-content { padding: 1.5rem 1rem;}
}
@media (max-width: 480px) {
  .btn, .option-btn { padding: 0.75rem; font-size: 0.9rem;}
  .subject-card { min-height: 8rem; padding: 1rem 0.75rem;}
  .history-item { min-width: 12rem;}
  footer { font-size: 0.85rem; padding: 1rem 0.75rem;}
}

/* Keyboard navigation focus */
button:focus-visible,
input:focus-visible,
select:focus-visible {
  outline: 2px solid #24c96b;
  outline-offset: 2px;
}

/* Print styles */
@media print {
  .container { background: white; color: black; box-shadow: none;}
  .no-print { display: none !important;}
}

/* Light theme variables */
body:not(.dark-mode) {
  --primary-color: #222;
  --secondary-color: #555;
  --dark-bg: #f5f7fa;
  --dark-card: #fff;
  --dark-text-color: #222;
  --accent-gradient: linear-gradient(90deg, #b1ff8a 0%, #24c96b 100%);
  --success-gradient: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
  --error-gradient: linear-gradient(90deg, #ff5858 0%, #f857a6 100%);
  --warning-gradient: linear-gradient(90deg, #ffb347 0%, #ff774e 100%);
  --option-gradient: linear-gradient(120deg, #5ee7df 0%, #3a8dde 100%);
  --secondary-gradient: linear-gradient(90deg, #eee 0%, #ddd 100%);
}
/* Light theme overrides */
body:not(.dark-mode) {
  background: var(--dark-bg);
  color: var(--dark-text-color);
}
body:not(.dark-mode) .container,
body:not(.dark-mode) .question,
body:not(.dark-mode) .subject-card,
body:not(.dark-mode) .modal-content,
body:not(.dark-mode) .stat-item,
body:not(.dark-mode) .instructions,
body:not(.dark-mode) .history-preview,
body:not(.dark-mode) .analysis-container {
  background: var(--dark-card);
  color: var(--dark-text-color);
  box-shadow: 0 0.25rem 0.9375rem rgba(0,0,0,0.07);
}
body:not(.dark-mode) .btn,
body:not(.dark-mode) .theme-toggle {
  background: var(--accent-gradient);
  color: #fff;
}
body:not(.dark-mode) .btn-secondary {
  background: var(--secondary-gradient);
  color: #555;
}
body:not(.dark-mode) .btn-success {
  background: var(--success-gradient);
  color: #fff;
}
body:not(.dark-mode) .btn-danger {
  background: var(--error-gradient);
  color: #fff;
}
body:not(.dark-mode) .btn-warning {
  background: var(--warning-gradient);
  color: #fff;
}
body:not(.dark-mode) .progress-container {
  background: #f0f0f0;
}
body:not(.dark-mode) .progress-bar {
  background: var(--accent-gradient);
  color: #fff;
}
body:not(.dark-mode) .question {
  border: 1px solid #ddd;
}
body:not(.dark-mode) .option-btn {
  background: var(--option-gradient);
  color: #222;
  border: 2px solid #bbb;
}
body:not(.dark-mode) .option-btn.selected {
  background: var(--accent-gradient);
  color: #fff;
  border-color: #24c96b;
}
body:not(.dark-mode) .question.mistake {
  border: 2px solid #f857a6;
  background: var(--error-gradient);
  color: #fff;
}
body:not(.dark-mode) .question.correct {
  border: 2px solid #43e97b;
  background: var(--success-gradient);
  color: #fff;
}
body:not(.dark-mode) .modal {
  background: rgba(240, 240, 240, 0.9);
  backdrop-filter: blur(3px);
}
body:not(.dark-mode) .modal-content {
  background: #fff;
  color: #222;
}
body:not(.dark-mode) .footer {
  background: #f2f3f7;
  color: #555;
  border-top: 1px solid #ddd;
}
body:not(.dark-mode) .footer-email {
  background: var(--accent-gradient);
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
}
body:not(.dark-mode) .footer-email:hover {
  background: linear-gradient(90deg, #b1ff8a 0%, #24c96b 100%);
  -webkit-background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
}
body:not(.dark-mode) .history-scroll { background: #f9f9f9;}
body:not(.dark-mode) .history-item {
  background: var(--option-gradient);
  color: #fff;
  border: 1px solid #e0e0e0;
}

/* Theme toggle button */
.theme-toggle { transition: background 0.2s, color 0.2s;}
</style>
<body>

<div class="container">
  <div id="homeScreen" class="home-container">
    <h1 align = "center">Gravithon</h1>
    <p>Practice and improve your OMR sheet filling skills with this interactive system. It is completely free.</p>
    
    <div class="instructions">
      <h3>How to Use:</h3>
<ul>
  <li>Select a subject from the list below.</li>
  <li>Enter the test details, including the title, question range, and time allotted per question.</li>
  <li>Obtain a physical copy of the question paper.</li>
  <li>Answer the questions by selecting one of the options (ক, খ, গ, ঘ).</li>
  <li>Submit your answers using the solution bank provided with the material once you have completed the test.</li>
  <li>Enter the correct answers to calculate your score.</li>
  <li>Review your history to monitor your progress over time.</li>
</ul>

<h3>Tips:</h3>
<ul>
  <li>Practice regularly to enhance your speed and accuracy.</li>
  <li>Begin with more time per question, then gradually reduce it as you improve.</li>
  <li>Analyze mistakes recorded in your history to avoid repeating them.</li>
  <li>This tool is particularly beneficial for HSC candidates and admission test aspirants.</li>
</ul>
    </div>
    
    <h3>Select Subject:</h3>
    <div class="subject-grid">
      <div class="subject-card" tabindex="0" data-subject="English 1st Paper" onclick="selectSubject('English 1st Paper')" onkeydown="handleSubjectKeyDown(event, 'English 1st Paper')">
        <div class="subject-icon">📘</div>
        <h3>English 1st Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="English 2nd Paper" onclick="selectSubject('English 2nd Paper')" onkeydown="handleSubjectKeyDown(event, 'English 2nd Paper')">
        <div class="subject-icon">📗</div>
        <h3>English 2nd Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Bengali 1st Paper" onclick="selectSubject('Bengali 1st Paper')" onkeydown="handleSubjectKeyDown(event, 'Bengali 1st Paper')">
        <div class="subject-icon">📕</div>
        <h3>Bengali 1st Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Bengali 2nd Paper" onclick="selectSubject('Bengali 2nd Paper')" onkeydown="handleSubjectKeyDown(event, 'Bengali 2nd Paper')">
        <div class="subject-icon">📙</div>
        <h3>Bengali 2nd Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Mathematics 1st Paper" onclick="selectSubject('Mathematics 1st Paper')" onkeydown="handleSubjectKeyDown(event, 'Mathematics 1st Paper')">
        <div class="subject-icon">🧮</div>
        <h3>Mathematics 1st Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Mathematics 2nd Paper" onclick="selectSubject('Mathematics 2nd Paper')" onkeydown="handleSubjectKeyDown(event, 'Mathematics 2nd Paper')">
        <div class="subject-icon">📐</div>
        <h3>Mathematics 2nd Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Physics 1st Paper" onclick="selectSubject('Physics 1st Paper')" onkeydown="handleSubjectKeyDown(event, 'Physics 1st Paper')">
        <div class="subject-icon">⚛️</div>
        <h3>Physics 1st Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Physics 2nd Paper" onclick="selectSubject('Physics 2nd Paper')" onkeydown="handleSubjectKeyDown(event, 'Physics 2nd Paper')">
        <div class="subject-icon">🔭</div>
        <h3>Physics 2nd Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Biology 1st Paper" onclick="selectSubject('Biology 1st Paper')" onkeydown="handleSubjectKeyDown(event, 'Biology 1st Paper')">
        <div class="subject-icon">🧬</div>
        <h3>Biology 1st Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Biology 2nd Paper" onclick="selectSubject('Biology 2nd Paper')" onkeydown="handleSubjectKeyDown(event, 'Biology 2nd Paper')">
        <div class="subject-icon">🌿</div>
        <h3>Biology 2nd Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Chemistry 1st Paper" onclick="selectSubject('Chemistry 1st Paper')" onkeydown="handleSubjectKeyDown(event, 'Chemistry 1st Paper')">
        <div class="subject-icon">🧪</div>
        <h3>Chemistry 1st Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Chemistry 2nd Paper" onclick="selectSubject('Chemistry 2nd Paper')" onkeydown="handleSubjectKeyDown(event, 'Chemistry 2nd Paper')">
        <div class="subject-icon">⚗️</div>
        <h3>Chemistry 2nd Paper</h3>
      </div>
      <div class="subject-card" tabindex="0" data-subject="Information and Communication Technology" onclick="selectSubject('Information and Communication Technology')" onkeydown="handleSubjectKeyDown(event, 'Information and Communication Technology')">
        <div class="subject-icon">💻</div>
        <h3>ICT</h3>
      </div>
    </div>
    
    <div class="history-preview">
      <h3>Recent History</h3>
      <div class="history-scroll" id="historyScroll">
        <!-- History items will be added here dynamically -->
      </div>
      <button class="btn" onclick="showHistory()" style="margin-top: 15px;">View All History</button>
    </div>
    
    <div class="analysis-container">
      <h3>Subject Analysis</h3>
      <div class="time-filter">
        <button class="active" onclick="filterAnalysis('all')">All Time</button>
        <button onclick="filterAnalysis('year')">Yearly</button>
        <button onclick="filterAnalysis('month')">Monthly</button>
        <button onclick="filterAnalysis('week')">Weekly</button>
      </div>
      <div class="chart-container" id="chartContainer">
        <!-- Chart will be rendered here -->
      </div>
    </div>
  </div>
  
  <div id="setupForm" style="display: none;">
    <button class="btn btn-secondary back-btn" onclick="goBackToHome()">← Back</button>
    <h1>Gravithon - <span id="subjectTitle"></span></h1>
    
    <div class="form-group">
      <label for="testTitle">Test Title:</label>
      <input type="text" id="testTitle" placeholder="Enter test title" />
    </div>
    
    <div class="form-group">
      <label for="startNum">Start Serial:</label>
      <input type="number" id="startNum" min="1" />
    </div>
    
    <div class="form-group">
      <label for="endNum">End Serial:</label>
      <input type="number" id="endNum" min="1" />
    </div>
    
    <div class="form-group">
      <label for="timePerQuestion">Time per Question (seconds):</label>
      <input type="number" id="timePerQuestion" min="10" value="60" />
    </div>
    <div class="form-group">
  <label for="optionStyle">Option Style:</label>
  <select id="optionStyle">
    <option value="bengali">ক, খ, গ, ঘ, ঙ, চ (Bengali Alphabetic)</option>
    <option value="en-lower">a, b, c, d, e, f (English lower)</option>
    <option value="en-upper">A, B, C, D, E, F (English upper)</option>
    <option value="roman-lower">i, ii, iii, iv, v, vi (Roman lower)</option>
    <option value="roman-upper">I, II, III, IV, V, VI (Roman upper)</option>
    <option value="numeric">1, 2, 3, 4, 5, 6 (Numeric)</option>
  </select>
</div>
<div class="form-group">
  <label for="optionCount">Number of Options per Question:</label>
  <select id="optionCount">
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4" selected>4</option>
    <option value="5">5</option>
    <option value="6">6</option>
  </select>
</div>

    <div class="controls">
      <button class="btn" onclick="startTest()">Start Test</button>
      <button class="btn btn-secondary" onclick="showHistory()">View History</button>
    </div>
  </div>

  <div id="timer" style="display: none;"></div>
  
  <div id="progressContainer" class="progress-container" style="display: none;">
    <div id="progressBar" class="progress-bar"></div>
  </div>

  <div id="questionContainer"></div>

  <div class="controls" id="testControls" style="display: none;">
    <button class="btn btn-success" onclick="submitAnswers()">Submit Answers</button>
    <button class="btn btn-danger" onclick="cancelTest()">Cancel Test</button>
    <button class="btn btn-secondary" onclick="saveForLater()">Save for Later</button>
  </div>
  
  <div id="resultStats" style="display: none;">
    <div class="stats">
      <div class="stat-item">
        <div>Total Questions</div>
        <div class="stat-value" id="totalQuestions">0</div>
      </div>
      <div class="stat-item">
        <div>Correct Answers</div>
        <div class="stat-value" id="correctAnswers">0</div>
      </div>
      <div class="stat-item">
        <div>Score</div>
        <div class="stat-value" id="scorePercentage">0%</div>
      </div>
    </div>
    <div class="controls">
      <button class="btn" onclick="goBackToHome()">Back to Home</button>
      <button class="btn btn-secondary" onclick="showHistory()">View History</button>
    </div>
  </div>
</div>

<!-- Modal for various purposes -->
<div class="modal" id="modal">
  <div class="modal-content" id="modalContent">
    <!-- content dynamically added -->
  </div>
</div>

<!-- History Modal -->
<div class="modal" id="historyModal">
  <div class="modal-content">
    <h3>Test History - <span id="historySubjectTitle"></span></h3>
    
    <div class="filter-controls">
      <select id="filterSubject" onchange="filterHistory()">
        <option value="all">All Subjects</option>
        <option value="English 1st Paper">English 1st Paper</option>
        <option value="English 2nd Paper">English 2nd Paper</option>
        <option value="Bengali 1st Paper">Bengali 1st Paper</option>
        <option value="Bengali 2nd Paper">Bengali 2nd Paper</option>
        <option value="Mathematics 1st Paper">Mathematics 1st Paper</option>
        <option value="Mathematics 2nd Paper">Mathematics 2nd Paper</option>
        <option value="Physics 1st Paper">Physics 1st Paper</option>
        <option value="Physics 2nd Paper">Physics 2nd Paper</option>
        <option value="Biology 1st Paper">Biology 1st Paper</option>
        <option value="Biology 2nd Paper">Biology 2nd Paper</option>
        <option value="Chemistry 1st Paper">Chemistry 1st Paper</option>
        <option value="Chemistry 2nd Paper">Chemistry 2nd Paper</option>
        <option value="Information and Communication Technology">ICT</option>
      </select>
      
      <select id="filterStatus" onchange="filterHistory()">
        <option value="all">All Status</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
      </select>
      
      <select id="filterSort" onchange="filterHistory()">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="highest">Highest Score</option>
        <option value="lowest">Lowest Score</option>
      </select>
      
      <input type="text" id="searchTitle" placeholder="Search by title" oninput="filterHistory()">
    </div>
    
    <div id="historyList" style="max-height: 400px; overflow-y: auto;"></div>
    <div class="modal-buttons">
      <button class="btn" onclick="closeHistoryModal()">Close</button>
    </div>
  </div>
</div>

<footer class="footer">
  Developed by <span class="footer-name"><a href = "https://github.com/thedhannomorich/Gravithon">thedhannomorich</a></span>.
  Support the developer by sending feedback at this email: 
  <span class="footer-email" id="copyEmail">thedhannomorich@gmail.com</span>
</footer>

<script>
// Application state
const state = {
  answers: {},
  correctAnswers: {},
  totalQuestions: 0,
  timer: null,
  timeLeft: 0,
  testTitle: '',
  testSubject: '',
  testStarted: false,
  currentQuestionSet: [],
  optionStyle: 'bengali',
  optionCount: 4,
  phase: 'answering' // Track whether in answering or correct answer phase
};

// Warn the user before reload if in test or answer input stage
window.addEventListener('beforeunload', function (e) {
  if (
    state.testStarted ||
    (elements.questionContainer && elements.questionContainer.innerHTML.includes('Correct Answer for Question'))
  ) {
    const confirmationMessage = 'You have an unfinished test. Are you sure you want to leave? Changes might not save.';
    (e || window.event).returnValue = confirmationMessage;
    return confirmationMessage;
  }
});

// DOM elements
const elements = {
  homeScreen: document.getElementById('homeScreen'),
  setupForm: document.getElementById('setupForm'),
  subjectTitle: document.getElementById('subjectTitle'),
  timer: document.getElementById('timer'),
  questionContainer: document.getElementById('questionContainer'),
  testControls: document.getElementById('testControls'),
  resultStats: document.getElementById('resultStats'),
  progressContainer: document.getElementById('progressContainer'),
  progressBar: document.getElementById('progressBar'),
  historySubjectTitle: document.getElementById('historySubjectTitle'),
  historyScroll: document.getElementById('historyScroll'),
  chartContainer: document.getElementById('chartContainer')
};

// Option label generator utility
function getOptionLabels(style, count) {
  const sets = {
    bengali: ['ক', 'খ', 'গ', 'ঘ', 'ঙ', 'চ'],
    'en-lower': ['a', 'b', 'c', 'd', 'e', 'f'],
    'en-upper': ['A', 'B', 'C', 'D', 'E', 'F'],
    'roman-lower': ['i', 'ii', 'iii', 'iv', 'v', 'vi'],
    'roman-upper': ['I', 'II', 'III', 'IV', 'V', 'VI'],
    numeric: ['1', '2', '3', '4', '5', '6']
  };
  return sets[style] ? sets[style].slice(0, count) : sets['bengali'].slice(0, count);
}

// Keyboard accessible subject selection
function handleSubjectKeyDown(event, subject) {
  if (event.key === 'Enter' || event.key === ' ') {
    selectSubject(subject);
  }
}

// Helper: Scroll to top for user focus
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Initialize the app
function init() {
  // Check for unfinished test
  const unfinishedTest = localStorage.getItem('currentTestData');
  if (unfinishedTest) {
    showModal(
      'You have an unfinished test. Would you like to continue?',
      () => {
        const testData = JSON.parse(unfinishedTest);
        Object.assign(state, testData.testState);
        state.answers = testData.answers || {};
        continueTest();
      },
      () => {
        localStorage.removeItem('currentTestData');
        loadRecentHistory();
      }
    );
  } else {
    loadRecentHistory();
  }

  renderSubjectAnalysis();
  startHistoryScroll();

  // Initialize dark mode if previously set
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }

  // Initialize email copy functionality
  document.getElementById('copyEmail')?.addEventListener('click', function () {
    const email = this.textContent;
    navigator.clipboard.writeText(email).then(() => {
      const originalText = this.textContent;
      this.textContent = 'Copied!';
      setTimeout(() => (this.textContent = originalText), 1500);
    }).catch(() => {
      alert('Failed to copy email. Please copy manually.');
    });
  });

  // Add theme toggle button
  if (!document.getElementById('themeToggle')) {
    const btn = document.createElement('button');
    btn.className = 'theme-toggle';
    btn.id = 'themeToggle';
    btn.type = 'button';
    btn.title = 'Toggle dark/light theme';
    btn.innerText = document.body.classList.contains('dark-mode') ? '🌞' : '🌓';
    btn.onclick = toggleTheme;
    document.body.appendChild(btn);
  }
}

function continueTest() {
  scrollToTop();
  elements.setupForm.style.display = 'none';
  elements.resultStats.style.display = 'none';
  elements.testControls.style.display = 'flex';
  elements.progressContainer.style.display = 'block';
  elements.timer.style.display = state.phase === 'answering' ? 'block' : 'none';
  elements.questionContainer.innerHTML = '';

  const optionLabels = getOptionLabels(state.optionStyle, state.optionCount);

  // Resume correct answer input phase if that's where the test was left
  if (state.phase === 'providing-correct') {
    state.currentQuestionSet.forEach(qNum => {
      const div = document.createElement('div');
      div.className = 'question';
      div.id = `q-${qNum}`;
      div.innerHTML = `
            <div class="question-number">Correct Answer for Question ${qNum}</div>
            <div class="options-container">
              ${optionLabels.map(opt =>
                `<button class="option-btn ${state.correctAnswers[qNum] === opt ? 'selected' : ''}" onclick="selectCorrect(${qNum}, '${opt}', this)">${opt}</button>`
              ).join('')}
            </div>
          `;
      elements.questionContainer.appendChild(div);
    });
    elements.testControls.innerHTML = `
        <button class="btn btn-success" onclick="checkAnswers()">Check Answers</button>
        <button class="btn btn-warning" onclick="saveForLater()">Save for Later</button>
        <button class="btn btn-secondary" onclick="goBackToHome()">Cancel</button>
        <button class="btn btn-info" onclick="showSubmitButton()">Show Submit Again</button>
      `;
    elements.progressContainer.style.display = 'none';
    elements.timer.style.display = 'none';
    state.testStarted = false;
  } else {
    // Resume answering phase
    state.currentQuestionSet.forEach(qNum => {
      const div = document.createElement('div');
      div.className = 'question';
      div.id = `q-${qNum}`;
      div.innerHTML = `
            <div class="question-number">Question ${qNum}</div>
            <div class="options-container">
              ${optionLabels.map(opt =>
                `<button class="option-btn ${state.answers[qNum] === opt ? 'selected' : ''}" onclick="selectAnswer(${qNum}, '${opt}', this)">${opt}</button>`
              ).join('')}
            </div>
          `;
      elements.questionContainer.appendChild(div);
    });
    elements.testControls.innerHTML = `
        <button class="btn btn-success" onclick="submitAnswers()">Submit Answers</button>
        <button class="btn btn-danger" onclick="cancelTest()">Cancel Test</button>
        <button class="btn btn-secondary" onclick="saveForLater()">Save for Later</button>
      `;
    updateProgress();
    // Restore timer
    clearInterval(state.timer);
    updateTimer();
    state.timer = setInterval(updateTimer, 1000);
    state.testStarted = true;
  }
}

function startHistoryScroll() {
  // No scroll if not enough items
  if (!elements.historyScroll) return;
  let scrollPosition = 0;
  function doScroll() {
    if (!elements.historyScroll) return;
    scrollPosition += 1;
    if (scrollPosition > elements.historyScroll.scrollWidth - elements.historyScroll.clientWidth) {
      scrollPosition = 0;
      setTimeout(() => {
        elements.historyScroll.scrollTo({ left: 0, behavior: 'instant' });
      }, 1000);
    }
    elements.historyScroll.scrollTo({ left: scrollPosition, behavior: 'smooth' });
  }
  setInterval(doScroll, 50);
}

function loadRecentHistory() {
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  history = history.slice(0, 5);
  elements.historyScroll.innerHTML = '';
  if (history.length === 0) {
    elements.historyScroll.innerHTML = '<p>No recent tests found.</p>';
    return;
  }
  history.forEach(test => {
    const testDiv = document.createElement('div');
    testDiv.className = 'history-item';
    testDiv.innerHTML = `
      <h4>${test.title}</h4>
      <p>${test.subject ?? ''}</p>
      <p>${test.date ?? ''}</p>
      ${test.score !== null && typeof test.score !== 'undefined' ? `<p><strong>Score:</strong> ${test.score}%</p>` : '<p>Pending</p>'}
    `;
    testDiv.addEventListener('click', () => viewTestDetails(test));
    elements.historyScroll.appendChild(testDiv);
  });
}

// Subject Analysis and chart rendering (unchanged)
function renderSubjectAnalysis(filter = 'all') {
  // ... (same as before)
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  const now = new Date();
  if (filter === 'year') {
    history = history.filter(test => {
      const testDate = new Date(test.date);
      return now.getFullYear() === testDate.getFullYear();
    });
  } else if (filter === 'month') {
    history = history.filter(test => {
      const testDate = new Date(test.date);
      return now.getFullYear() === testDate.getFullYear() &&
        now.getMonth() === testDate.getMonth();
    });
  } else if (filter === 'week') {
    history = history.filter(test => {
      const testDate = new Date(test.date);
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      return testDate >= oneWeekAgo;
    });
  }
  const subjects = [
    'English 1st Paper', 'English 2nd Paper',
    'Bengali 1st Paper', 'Bengali 2nd Paper',
    'Mathematics 1st Paper', 'Mathematics 2nd Paper',
    'Physics 1st Paper', 'Physics 2nd Paper',
    'Biology 1st Paper', 'Biology 2nd Paper',
    'Chemistry 1st Paper', 'Chemistry 2nd Paper',
    'Information and Communication Technology'
  ];
  const subjectData = {};
  subjects.forEach(subject => {
    const subjectTests = history.filter(test => test.subject === subject && test.score !== null);
    if (subjectTests.length > 0) {
      const totalScore = subjectTests.reduce((sum, test) => sum + test.score, 0);
      subjectData[subject] = Math.round(totalScore / subjectTests.length);
    } else {
      subjectData[subject] = 0;
    }
  });
  elements.chartContainer.innerHTML = '';
  const maxScore = Math.max(...Object.values(subjectData), 100) || 100;
  const chartHeight = 250;
  subjects.forEach(subject => {
    const score = subjectData[subject] || 0;
    const barHeight = (score / maxScore) * chartHeight;
    const barContainer = document.createElement('div');
    barContainer.className = 'bar-container';
    barContainer.style.height = `${chartHeight}px`;
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = `${barHeight}px`;
    bar.style.backgroundColor = getSubjectColor(subject);
    bar.title = `${subject}: ${score}%`;
    if (score > 0) {
      bar.textContent = score;
    }
    const label = document.createElement('div');
    label.className = 'chart-label';
    label.textContent =
      subject === 'Information and Communication Technology'
        ? 'ICT'
        : subject.split(' ').slice(0, 2).join(' ');
    barContainer.appendChild(bar);
    barContainer.appendChild(label);
    elements.chartContainer.appendChild(barContainer);
  });
}

function getSubjectColor(subject) {
  const colors = {
    'English 1st Paper': '#3a506b',
    'English 2nd Paper': '#3a506b',
    'Bengali 1st Paper': '#5d5179',
    'Bengali 2nd Paper': '#5d5179',
    'Mathematics 1st Paper': '#6a4c93',
    'Mathematics 2nd Paper': '#6a4c93',
    'Physics 1st Paper': '#1982c4',
    'Physics 2nd Paper': '#1982c4',
    'Biology 1st Paper': '#8ac926',
    'Biology 2nd Paper': '#8ac926',
    'Chemistry 1st Paper': '#ff595e',
    'Chemistry 2nd Paper': '#ff595e',
    'Information and Communication Technology': '#ffca3a'
  };
  return colors[subject] || '#444';
}

function filterAnalysis(filter) {
  document.querySelectorAll('.time-filter button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  renderSubjectAnalysis(filter);
}

function selectSubject(subject) {
  scrollToTop();
  state.testSubject = subject;
  elements.subjectTitle.textContent = subject;
  elements.homeScreen.style.display = 'none';
  elements.setupForm.style.display = 'block';
  elements.resultStats.style.display = 'none';
  elements.questionContainer.innerHTML = '';
}

function goBackToHome() {
  if (state.testStarted || state.phase === 'providing-correct') {
    showModal(
      'Are you sure you want to cancel this test? It will be removed from history.',
      () => {
        clearInterval(state.timer);
        removePendingFromHistory();
        resetToHome();
      },
      () => { /* do nothing, stay */ }
    );
  } else {
    resetToHome();
  }
}

function resetToHome() {
  // Clear any existing timer
  if (state.timer) {
    clearInterval(state.timer);
    state.timer = null;
  }
  elements.homeScreen.style.display = 'block';
  elements.setupForm.style.display = 'none';
  elements.timer.style.display = 'none';
  elements.testControls.style.display = 'none';
  elements.progressContainer.style.display = 'none';
  elements.questionContainer.innerHTML = '';
  elements.resultStats.style.display = 'none';
  state.testStarted = false;
  state.phase = 'answering';
  state.answers = {};
  state.correctAnswers = {};
  state.currentQuestionSet = [];
  state.optionStyle = 'bengali';
  state.optionCount = 4;
  localStorage.removeItem('currentTestData');
}

function removePendingFromHistory() {
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  // Remove the first pending test that matches the current test title & subject (most recent)
  const idx = history.findIndex(
    t => t.status === 'pending' &&
      t.title === state.testTitle &&
      t.subject === state.testSubject
  );
  if (idx > -1) {
    history.splice(idx, 1);
    localStorage.setItem('omrHistory', JSON.stringify(history));
    loadRecentHistory();
    renderSubjectAnalysis();
  }
}

function startTest() {
  scrollToTop();
  localStorage.removeItem('currentTestData');
  state.answers = {};
  state.correctAnswers = {};
  state.phase = 'answering';

  state.testTitle = document.getElementById('testTitle').value.trim();
  const start = parseInt(document.getElementById('startNum').value);
  const end = parseInt(document.getElementById('endNum').value);
  const timePerQuestion = parseInt(document.getElementById('timePerQuestion').value) || 60;
  // Get new fields
  state.optionStyle = (document.getElementById('optionStyle') && document.getElementById('optionStyle').value) || 'bengali';
  state.optionCount = parseInt(document.getElementById('optionCount') && document.getElementById('optionCount').value, 10) || 4;

  elements.testControls.style.display = 'none';
  if (!state.testTitle) {
    showModal('Test title cannot be empty!', () => {}, () => {});
    return;
  }
  if (isNaN(start) || isNaN(end) || end < start) {
    showModal('Please enter valid serial numbers!', () => {}, () => {});
    return;
  }
  if (state.optionCount < 2 || state.optionCount > 6) {
    showModal('Option count must be between 2 and 6.', () => {}, () => {});
    return;
  }

  elements.testControls.style.display = 'flex';
  elements.testControls.innerHTML = `
    <button class="btn btn-success" onclick="submitAnswers()">Submit Answers</button>
    <button class="btn btn-danger" onclick="cancelTest()">Cancel Test</button>
    <button class="btn btn-secondary" onclick="saveForLater()">Save for Later</button>
  `;

  state.totalQuestions = end - start + 1;
  state.timeLeft = state.totalQuestions * timePerQuestion;
  state.answers = {};
  state.correctAnswers = {};
  state.currentQuestionSet = Array.from({ length: end - start + 1 }, (_, i) => start + i);
  state.testStarted = true;

  elements.setupForm.style.display = 'none';
  elements.timer.style.display = 'block';
  elements.testControls.style.display = 'flex';
  elements.progressContainer.style.display = 'block';
  elements.questionContainer.innerHTML = '';
  elements.resultStats.style.display = 'none';

  const optionLabels = getOptionLabels(state.optionStyle, state.optionCount);

  state.currentQuestionSet.forEach(qNum => {
    const div = document.createElement('div');
    div.className = 'question';
    div.id = `q-${qNum}`;
    div.innerHTML = `
      <div class="question-number">Question ${qNum}</div>
      <div class="options-container">
        ${optionLabels.map(opt =>
          `<button class="option-btn" onclick="selectAnswer(${qNum}, '${opt}', this)">${opt}</button>`
        ).join('')}
      </div>
    `;
    elements.questionContainer.appendChild(div);
  });

  updateTimer();
  updateProgress();
  clearInterval(state.timer);
  state.timer = setInterval(updateTimer, 1000);
}

function selectAnswer(qNum, ans, btn) {
  state.answers[qNum] = ans;
  localStorage.setItem('currentTestData', JSON.stringify({
    answers: state.answers,
    testState: state
  }));
  const questionDiv = btn.closest('.question');
  const buttons = questionDiv.querySelectorAll('.option-btn');
  buttons.forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateProgress();
}

function updateTimer() {
  if (state.timeLeft <= 0) {
    clearInterval(state.timer);
    showModal('Time is up!', () => { submitAnswers(); }, () => {});
    return;
  }
  const minutes = Math.floor(state.timeLeft / 60);
  const seconds = state.timeLeft % 60;
  elements.timer.innerHTML = `Time Remaining: <span style="color: ${state.timeLeft <= 60 ? 'red' : 'var(--primary-color)'}">${minutes}:${seconds < 10 ? '0' : ''}${seconds}</span>`;
  state.timeLeft--;
}

function updateProgress() {
  const answered = Object.keys(state.answers).length;
  const percentage = Math.round((answered / state.totalQuestions) * 100);
  elements.progressBar.style.width = `${percentage}%`;
  elements.progressBar.textContent = `${percentage}%`;
}

function submitAnswers() {
  scrollToTop();
  clearInterval(state.timer);
  state.testStarted = false;
  state.phase = 'providing-correct';
  showModal(
    'Are you ready to provide the correct answers?',
    () => {
      elements.questionContainer.innerHTML = '';
      const optionLabels = getOptionLabels(state.optionStyle, state.optionCount);
      state.currentQuestionSet.forEach(qNum => {
        const div = document.createElement('div');
        div.className = 'question';
        div.id = `q-${qNum}`;
        div.innerHTML = `
          <div class="question-number">Correct Answer for Question ${qNum}</div>
          <div class="options-container">
            ${optionLabels.map(opt =>
              `<button class="option-btn" onclick="selectCorrect(${qNum}, '${opt}', this)">${opt}</button>`
            ).join('')}
          </div>
        `;
        elements.questionContainer.appendChild(div);
      });
      elements.testControls.innerHTML = `
        <button class="btn btn-success" onclick="checkAnswers()">Check Answers</button>
        <button class="btn btn-warning" onclick="saveForLater()">Save for Later</button>
        <button class="btn btn-secondary" onclick="goBackToHome()">Cancel</button>
        <button class="btn btn-info" onclick="showSubmitButton()">Show Submit Again</button>
      `;
      elements.progressContainer.style.display = 'none';
      elements.timer.style.display = 'none';
    },
    () => {
      // If user cancels, allow them to save for later or resume test
      showModal("You can save for later or return to the test. Do you want to save for later?",
        () => { saveForLater(); },
        () => { continueTest(); }
      );
    }
  );
}

function showSubmitButton() {
  elements.testControls.innerHTML = `
    <button class="btn btn-success" onclick="submitAnswers()">Submit Answers</button>
    <button class="btn btn-danger" onclick="cancelTest()">Cancel Test</button>
    <button class="btn btn-secondary" onclick="saveForLater()">Save for Later</button>
  `;
}

function selectCorrect(qNum, ans, btn) {
  state.correctAnswers[qNum] = ans;
  localStorage.setItem('currentTestData', JSON.stringify({
    answers: state.answers,
    testState: state
  }));
  const questionDiv = btn.closest('.question');
  const buttons = questionDiv.querySelectorAll('.option-btn');
  buttons.forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

function checkAnswers() {
  let correctCount = 0;
  state.currentQuestionSet.forEach(qNum => {
    const questionDiv = document.getElementById(`q-${qNum}`);
    const userAnswer = state.answers[qNum];
    const correctAnswer = state.correctAnswers[qNum];
    if (userAnswer === correctAnswer) {
      correctCount++;
      questionDiv.classList.add('correct');
    } else {
      questionDiv.classList.add('mistake');
    }
  });
  const score = Math.round((correctCount / state.totalQuestions) * 100);
  document.getElementById('totalQuestions').textContent = state.totalQuestions;
  document.getElementById('correctAnswers').textContent = correctCount;
  document.getElementById('scorePercentage').textContent = `${score}%`;
  elements.resultStats.style.display = 'block';
  elements.testControls.style.display = 'none';
  elements.timer.style.display = 'none';
  elements.progressContainer.style.display = 'none';
  saveToHistory('completed', state.answers, state.correctAnswers, state.totalQuestions, score, null, null, 'completed');
  localStorage.removeItem('currentTestData');
  showModal(`Your score: ${correctCount} / ${state.totalQuestions} (${score}%)`, () => { goBackToHome(); }, null);
}

function saveForLater() {
  // Save all necessary state for resuming the test (including phase)
  saveToHistory('pending', state.answers, state.correctAnswers, state.totalQuestions, null, state.timeLeft, { ...state }, state.phase);
  localStorage.removeItem('currentTestData');
  showModal('Your progress has been saved for later!', () => { resetToHome(); }, null);
}

function cancelTest() {
  showModal(
    'Are you sure you want to cancel this test? It will be removed from history.',
    () => {
      clearInterval(state.timer);
      removePendingFromHistory();
      resetToHome();
    },
    () => { /* do nothing, stay */ }
  );
}

function saveToHistory(status, answers, corrects, total, score, timeLeft = null, extraState = null, phase = "answering") {
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  // Remove any existing pending entry for the same title & subject (keep only latest)
  history = history.filter(t => !(t.status === 'pending' && t.title === state.testTitle && t.subject === state.testSubject));
  history.unshift({
    title: state.testTitle,
    subject: state.testSubject,
    date: new Date().toLocaleString(),
    status: status,
    answers: { ...answers },
    correctAnswers: { ...corrects },
    total: total,
    score: score,
    questionSet: [...state.currentQuestionSet],
    timeLeft: timeLeft,
    extraState: extraState,
    phase: phase
  });
  localStorage.setItem('omrHistory', JSON.stringify(history));
  loadRecentHistory();
  renderSubjectAnalysis();
}

function showHistory() {
  const history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  displayHistory(history);
  document.getElementById('historyModal').style.display = 'flex';
}

function filterHistory() {
  const subjectFilter = document.getElementById('filterSubject').value;
  const statusFilter = document.getElementById('filterStatus').value;
  const sortFilter = document.getElementById('filterSort').value;
  const searchTerm = document.getElementById('searchTitle').value.toLowerCase();
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  let filteredHistory = history.filter(test => {
    const subjectMatch = subjectFilter === 'all' || test.subject === subjectFilter;
    let statusMatch = true;
    if (statusFilter === 'completed') {
      statusMatch = test.status === 'completed';
    } else if (statusFilter === 'pending') {
      statusMatch = test.status === 'pending';
    }
    const searchMatch = test.title.toLowerCase().includes(searchTerm) ||
      (test.subject && test.subject.toLowerCase().includes(searchTerm));
    return subjectMatch && statusMatch && searchMatch;
  });
  switch (sortFilter) {
    case 'newest':
      filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
      break;
    case 'oldest':
      filteredHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
      break;
    case 'highest':
      filteredHistory.sort((a, b) => {
        const aScore = a.score !== null && typeof a.score !== 'undefined' ? a.score : -1;
        const bScore = b.score !== null && typeof b.score !== 'undefined' ? b.score : -1;
        return bScore - aScore;
      });
      break;
    case 'lowest':
      filteredHistory.sort((a, b) => {
        const aScore = a.score !== null && typeof a.score !== 'undefined' ? a.score : Infinity;
        const bScore = b.score !== null && typeof b.score !== 'undefined' ? b.score : Infinity;
        return aScore - bScore;
      });
      break;
  }
  displayHistory(filteredHistory);
}

function displayHistory(history) {
  const historyList = document.getElementById('historyList');
  historyList.innerHTML = '';
  if (history.length === 0) {
    historyList.innerHTML = '<p>No matching tests found.</p>';
  } else {
    history.forEach((test, index) => {
      const testDiv = document.createElement('div');
      testDiv.style.padding = '10px';
      testDiv.style.borderBottom = '1px solid #444';
      testDiv.style.cursor = 'pointer';
      let statusColor = '#6c757d';
      if (test.status === 'completed') statusColor = 'var(--success-color)';
      else if (test.status === 'pending') statusColor = 'var(--warning-color)';
      testDiv.innerHTML = `
        <div style="font-weight: bold;">${test.title}</div>
        <div style="font-size: 0.9em; color: #aaa;">${test.subject ?? ''} • ${test.date ?? ''}</div>
        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
          <span style="color: ${statusColor}">${test.status.toUpperCase()}</span>
          ${test.score !== null && typeof test.score !== 'undefined' ? `<span style="font-weight: bold;">Score: ${test.score}%</span>` : ''}
        </div>
      `;
      testDiv.addEventListener('click', () => viewTestDetails(test));
      historyList.appendChild(testDiv);
    });
  }
}

function viewTestDetails(test) {
  let content = `
    <h3>${test.title}</h3>
    <p><strong>Subject:</strong> ${test.subject ?? ''}</p>
    <p><strong>Date:</strong> ${test.date ?? ''}</p>
    <p><strong>Status:</strong> ${test.status ?? ''}</p>
    ${test.score !== null && typeof test.score !== 'undefined' ? `<p><strong>Score:</strong> ${test.score}%</p>` : ''}
    <p><strong>Questions:</strong> ${test.questionSet ? test.questionSet[0] : ''} to ${test.questionSet ? test.questionSet[test.questionSet.length - 1] : ''}</p>
  `;

  if (test.status === 'pending') {
    if (test.phase === 'providing-correct') {
      content += `<div class="modal-buttons">
        <button class="btn btn-success" onclick="resumePendingTest('${test.date}', true)">Resume Providing Correct Answers</button>
        <button class="btn btn-danger" onclick="removeSinglePendingFromHistory('${test.title.replace(/'/g, "\\'")}', '${test.subject.replace(/'/g, "\\'")}')">Remove</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>`;
    } else {
      content += `<div class="modal-buttons">
        <button class="btn btn-success" onclick="resumePendingTest('${test.date}', false)">Resume Test</button>
        <button class="btn btn-danger" onclick="removeSinglePendingFromHistory('${test.title.replace(/'/g, "\\'")}', '${test.subject.replace(/'/g, "\\'")}')">Remove</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>`;
    }
  } else if (test.status === 'completed') {
    content += `<div style="max-height: 300px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
      <h4>Question Details</h4>
      <table style="width: 100%; border-collapse: collapse;">
        <tr style="background: #444;">
          <th style="padding: 8px; text-align: left;">Question</th>
          <th style="padding: 8px; text-align: left;">Your Answer</th>
          <th style="padding: 8px; text-align: left;">Correct Answer</th>
        </tr>`;
    test.questionSet.forEach(qNum => {
      const userAns = test.answers[qNum] || 'Not answered';
      const correctAns = test.correctAnswers[qNum] || '-';
      const isCorrect = userAns === correctAns;
      content += `
        <tr style="border-bottom: 1px solid #444; background: ${isCorrect ? '#2a3a2a' : '#442a2a'}">
          <td style="padding: 8px;">${qNum}</td>
          <td style="padding: 8px;">${userAns}</td>
          <td style="padding: 8px;">${correctAns}</td>
        </tr>
      `;
    });
    content += `</table></div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>`;
  }

  showModal(content);
  closeHistoryModal();
}

// Remove a single pending entry by title and subject
function removeSinglePendingFromHistory(title, subject) {
  let history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  const idx = history.findIndex(t => t.status === 'pending' && t.title === title && t.subject === subject);
  if (idx > -1) {
    history.splice(idx, 1);
    localStorage.setItem('omrHistory', JSON.stringify(history));
    loadRecentHistory();
    renderSubjectAnalysis();
    showModal('Pending test removed from history.', () => { closeModal(); }, null);
  } else {
    showModal('Pending test not found.', () => { closeModal(); }, null);
  }
}

// Resuming a pending test
function resumePendingTest(date, isCorrectPhase = false) {
  scrollToTop();
  const history = JSON.parse(localStorage.getItem('omrHistory') || '[]');
  const test = history.find(t => t.date === date && t.status === 'pending');
  if (!test) {
    showModal('Pending test not found.', () => {}, null);
    return;
  }
  // Restore state
  state.testTitle = test.title;
  state.testSubject = test.subject;
  state.currentQuestionSet = test.questionSet;
  state.totalQuestions = test.total;
  state.answers = test.answers || {};
  state.correctAnswers = test.correctAnswers || {};
  state.timeLeft = test.timeLeft || (test.total * 60);
  state.phase = test.phase || "answering";
  state.optionStyle = (test.extraState && test.extraState.optionStyle) || 'bengali';
  state.optionCount = (test.extraState && test.extraState.optionCount) || 4;
  state.testStarted = !isCorrectPhase;
  // Save to localStorage for crash recovery
  localStorage.setItem('currentTestData', JSON.stringify({
    answers: state.answers,
    testState: { ...state }
  }));
  closeModal();
  elements.homeScreen.style.display = 'none';
  elements.setupForm.style.display = 'none';
  elements.resultStats.style.display = 'none';
  if (isCorrectPhase || state.phase === 'providing-correct') {
    state.phase = 'providing-correct';
    elements.questionContainer.innerHTML = '';
    const optionLabels = getOptionLabels(state.optionStyle, state.optionCount);
    state.currentQuestionSet.forEach(qNum => {
      const div = document.createElement('div');
      div.className = 'question';
      div.id = `q-${qNum}`;
      div.innerHTML = `
        <div class="question-number">Correct Answer for Question ${qNum}</div>
        <div class="options-container">
          ${optionLabels.map(opt =>
            `<button class="option-btn ${state.correctAnswers[qNum] === opt ? 'selected' : ''}" onclick="selectCorrect(${qNum}, '${opt}', this)">${opt}</button>`
          ).join('')}
        </div>
      `;
      elements.questionContainer.appendChild(div);
    });
    elements.testControls.style.display = 'flex';
    elements.testControls.innerHTML = `
      <button class="btn btn-success" onclick="checkAnswers()">Check Answers</button>
      <button class="btn btn-warning" onclick="saveForLater()">Save for Later</button>
      <button class="btn btn-secondary" onclick="goBackToHome()">Cancel</button>
      <button class="btn btn-info" onclick="showSubmitButton()">Show Submit Again</button>
    `;
    elements.progressContainer.style.display = 'none';
    elements.timer.style.display = 'none';
  } else {
    // Resume answering
    elements.timer.style.display = 'block';
    elements.progressContainer.style.display = 'block';
    elements.testControls.style.display = 'flex';
    elements.questionContainer.innerHTML = '';
    const optionLabels = getOptionLabels(state.optionStyle, state.optionCount);
    state.currentQuestionSet.forEach(qNum => {
      const div = document.createElement('div');
      div.className = 'question';
      div.id = `q-${qNum}`;
      div.innerHTML = `
        <div class="question-number">Question ${qNum}</div>
        <div class="options-container">
          ${optionLabels.map(opt =>
            `<button class="option-btn ${state.answers[qNum] === opt ? 'selected' : ''}" onclick="selectAnswer(${qNum}, '${opt}', this)">${opt}</button>`
          ).join('')}
        </div>
      `;
      elements.questionContainer.appendChild(div);
    });
    elements.testControls.innerHTML = `
      <button class="btn btn-success" onclick="submitAnswers()">Submit Answers</button>
      <button class="btn btn-danger" onclick="cancelTest()">Cancel Test</button>
      <button class="btn btn-secondary" onclick="saveForLater()">Save for Later</button>
    `;
    updateProgress();
    clearInterval(state.timer);
    updateTimer();
    state.timer = setInterval(updateTimer, 1000);
  }
}

// Modal functions
function showModal(message, onConfirm, onCancel) {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  content.innerHTML = `<p>${message}</p>`;
  const buttons = document.createElement('div');
  buttons.className = 'modal-buttons';
  if (onConfirm) {
    buttons.innerHTML += `<button class="btn" onclick="closeModal(true)">Yes</button>`;
  }
  if (onCancel) {
    buttons.innerHTML += `<button class="btn btn-secondary" onclick="closeModal(false)">No</button>`;
  }
  if (!onConfirm && !onCancel) {
    buttons.innerHTML += `<button class="btn" onclick="closeModal()">OK</button>`;
  }
  content.appendChild(buttons);
  modal.dataset.onConfirm = onConfirm ? onConfirm.toString() : '';
  modal.dataset.onCancel = onCancel ? onCancel.toString() : '';
  modal.style.display = 'flex';
}

function closeModal(confirmed) {
  const modal = document.getElementById('modal');
  modal.style.display = 'none';
  if (confirmed === true && modal.dataset.onConfirm) {
    eval('(' + modal.dataset.onConfirm + ')')();
  } else if (confirmed === false && modal.dataset.onCancel) {
    eval('(' + modal.dataset.onCancel + ')')();
  }
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDark);
  document.getElementById('themeToggle').textContent = isDark ? '🌞' : '🌓';
}

function closeHistoryModal() {
  document.getElementById('historyModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
